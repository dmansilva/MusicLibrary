package server;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import database.DBHelper;
import threadSafety.ThreadSafeMusicLibrary;

public class NewAccountServlet extends BaseServlet{
	
	DBHelper dbhelper = new DBHelper();
	
	
	public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		String header = header();
		
		String accountInfo = "<html" +
							"<body>" +
							"<form action=\"newUser\" method=\"post\">" +
							"<center> Create New User </center><br/>" + 
							"<center> Full Name: " +
							"<input type=\"text\" name=\"fullname\"></center><br/>" +
							"<center> Username: "  +
							"<input type=\"text\" name=\"username\"></center><br/>" +
							"<center> Password: "  +
							"<input type=\"text\" name=\"password\"><br/>" +
							"<center> Verify Password: " +
							"<input type=\"text\" name=\"vpassword\"><br/>" +
							"<input type=\"submit\" value=\"Create Account\"></center><br/>" +
							"</form>" +
							"</body>" +
							"</html>";
		
		String responseHtml = header + accountInfo;
		PrintWriter writer = prepareResponse(response);
		writer.println(responseHtml);
	}
	
	
	public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		String fullname = request.getParameter(FULLNAME);
		String username = request.getParameter(USERNAME);
		String password = request.getParameter(PASSWORD);
		String verifypass = request.getParameter(VERIFYPASS);
		
		if ((fullname == null || fullname.trim().equals("")) || (username == null || username.trim().equals(""))) {
			response.sendRedirect(response.encodeRedirectURL("/newUser?" + STATUS + "=" + ERROR));
			return;
		}
		if ((password == null || password.trim().equals("")) || (verifypass == null || verifypass.trim().equals(""))) {
			response.sendRedirect(response.encodeRedirectURL("/newUser?" + STATUS + "=" + ERROR));
			return;
		}
		
		if (!password.equals(verifypass)) {
			response.sendRedirect(response.encodeRedirectURL("/newUser?" + "Passwords don't match"));
			return;
		}
		
		if (DBHelper.verifyUserName(USERNAME, PASSWORD)) {
			response.sendRedirect(response.encodeRedirectURL("/newUser?" + "Username already exists"));
			return;
		}
		
		HttpSession session = request.getSession();
		session.setAttribute(FULLNAME, fullname);
		session.setAttribute(USERNAME, username);
		session.setAttribute(PASSWORD, password);
		
		DBHelper.addUser(fullname, username, password);
		
		
		if (!)
		
		
		
		
		response.sendRedirect(response.encodeRedirectURL("/search"));	
				
		
		
	}
	
	

}
